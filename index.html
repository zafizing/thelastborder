<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE LAST BORDER | v11.0.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        body, html { background: #000; color: #0f0; font-family: monospace; margin: 0; overflow: hidden; }
        canvas { display: block; background: #050505; cursor: crosshair; }
        .ui { position: fixed; z-index: 10; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #0f0; }
        #stats { bottom: 10px; right: 10px; }
        #controls { top: 10px; left: 10px; width: 200px; }
        #wallet { top: 10px; right: 10px; }
        #popup { 
            position: fixed; display: none; background: #000; border: 2px solid #f00; 
            padding: 15px; z-index: 100; text-align: center; color: #fff;
        }
        button { background: #0f0; color: #000; border: none; padding: 8px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="controls" class="ui">
        <div style="font-size: 12px; margin-bottom: 5px;">WAR CONSOLE v11</div>
        <select id="nationSelect" style="width:100%; background:#000; color:#0f0; border:1px solid #0f0;"></select>
    </div>

    <div id="wallet" class="ui">
        <div id="addr" style="font-size: 10px; color: #f00;">OFFLINE</div>
        <button onclick="connect()">CONNECT</button>
    </div>

    <div id="stats" class="ui">
        <div id="coords">X: 0, Y: 0</div>
    </div>

    <div id="popup">
        <div id="price">1.00 USD</div>
        <button onclick="buy()">CONQUER</button>
        <button onclick="this.parentElement.style.display='none'" style="background:#444; color:#fff;">X</button>
    </div>

    <canvas id="map"></canvas>

    <script>
        const SB_URL = "https://vwehxkrcsxvgsonhlpms.supabase.co";
        const SB_KEY = "sb_publishable_Xu7IJwTu2SlVVL8gqi0HEQ_iZu4Xtxk";
        
        let supabase, wallet, selectedKey;
        let territories = {};
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        const SIZE = 20; // Kare boyutu
        
        // Zoom & Pan
        let scale = 1, offsetX = 0, offsetY = 0;

        async function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            supabase = window.supabase.createClient(SB_URL, SB_KEY);
            loadData();

            // Ülkeleri çek
            const r = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
            const data = await r.json();
            data.sort((a,b)=>a.name.common.localeCompare(b.name.common)).forEach(c => {
                const o = document.createElement('option');
                o.value = c.cca2.toLowerCase(); o.textContent = c.name.common.toUpperCase();
                document.getElementById('nationSelect').appendChild(o);
            });

            draw();
        }

        async function loadData() {
            const { data } = await supabase.from('territory').select('*');
            if(data) {
                data.forEach(t => territories[t.pixel_key] = t);
                draw();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);

            // Izgara çiz
            ctx.strokeStyle = "#111";
            for(let i=0; i<2000; i+=SIZE) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,2000); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(2000,i); ctx.stroke();
            }

            // Alınan yerleri çiz
            for(let k in territories) {
                const [x, y] = k.split(',').map(Number);
                ctx.fillStyle = "#f00";
                ctx.fillRect(x*SIZE, y*SIZE, SIZE, SIZE);
            }

            ctx.restore();
        }

        // Mouse İşlemleri
        canvas.onmousedown = (e) => {
            if(e.button === 0) { // Sol tık: Seçim
                const rect = canvas.getBoundingClientRect();
                const worldX = (e.clientX - offsetX) / scale;
                const worldY = (e.clientY - offsetY) / scale;
                const gx = Math.floor(worldX / SIZE);
                const gy = Math.floor(worldY / SIZE);
                
                selectedKey = `${gx},${gy}`;
                const p = document.getElementById('popup');
                p.style.display = 'block';
                p.style.left = e.clientX + 'px';
                p.style.top = e.clientY + 'px';
            }
        };

        // Hareket (Pan)
        canvas.onmousemove = (e) => {
            if(e.buttons === 2) { // Sağ tık: Kaydır
                offsetX += e.movementX;
                offsetY += e.movementY;
                draw();
            }
            const wx = Math.floor((e.clientX - offsetX) / (scale * SIZE));
            const wy = Math.floor((e.clientY - offsetY) / (scale * SIZE));
            document.getElementById('coords').innerText = `X: ${wx}, Y: ${wy}`;
        };

        window.oncontextmenu = (e) => e.preventDefault(); // Sağ tık menüsünü kapat

        async function connect() {
            const p = window.solana;
            if(!p) return alert("Phantom yükle");
            const r = await p.connect();
            wallet = r.publicKey.toString();
            document.getElementById('addr').innerText = wallet.slice(0,8) + "...";
            document.getElementById('addr').style.color = "#0f0";
        }

        async function buy() {
            if(!wallet) return alert("Cüzdan bağla");
            const nation = document.getElementById('nationSelect').value;
            const { error } = await supabase.from('territory').upsert({
                pixel_key: selectedKey,
                owner_address: wallet,
                nation_code: nation,
                price: 1.0
            });
            if(error) alert(error.message);
            else { alert("BAŞARILI!"); loadData(); }
        }

        init();
    </script>
</body>
</html>
