<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE LAST BORDER | v7.2 GLOBAL</title>
    <style>
        body, html { 
            background-color: #020205; color: #d4af37; 
            font-family: 'Courier New', monospace; margin: 0; padding: 0; 
            width: 100%; height: 100%; overflow: hidden; 
        }
        #war-room { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: #000; }
        #canvas-container { position: absolute; transform-origin: 0 0; will-change: transform; }
        canvas { background-color: #0d0d0d; image-rendering: pixelated; cursor: crosshair; }

        /* UI PANELS */
        .panel { 
            position: fixed; z-index: 100; background: rgba(5, 5, 15, 0.95); 
            padding: 15px; border: 1px solid #ff4500; backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.2);
        }
        #ui-overlay { top: 20px; left: 20px; width: 280px; }
        #arsenal-panel { top: 20px; right: 20px; width: 220px; border-color: #00ff00; }
        
        select, button { 
            background: #000; color: #00ff00; border: 1px solid #00ff00; 
            padding: 10px; width: 100%; cursor: pointer; margin-top: 8px; 
            font-family: inherit; font-size: 12px; outline: none;
        }
        .ammo-display { font-size: 28px; color: #00ff00; text-align: center; margin: 10px 0; text-shadow: 0 0 10px #00ff00; font-weight: bold; }
        .btn-buy { background: #00ff00; color: #000; font-weight: bold; border: none; transition: 0.2s; }
        .btn-buy:hover { background: #fff; box-shadow: 0 0 15px #00ff00; }
        
        #intel-panel { 
            position: fixed; bottom: 20px; left: 20px; font-size: 11px; 
            color: #ff4500; pointer-events: none; background: rgba(0,0,0,0.7); padding: 5px;
        }
        .loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; justify-content: center; align-items: center; color: #ff4500;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">INITIALIZING GLOBAL DATABASE...</div>

    <div id="war-room">
        <div id="ui-overlay" class="panel">
            <h2 style="margin:0; color: #ff4500; font-size: 18px; letter-spacing: 2px;">COMMAND CENTER</h2>
            <div style="margin-top:15px;">
                <label style="font-size: 10px; color: #888;">SELECT SOVEREIGN NATION:</label>
                <select id="nationSelect"></select>
            </div>
            <div id="status-text" style="font-size: 10px; margin-top: 15px; color: #ff4500; border-top: 1px solid #333; padding-top: 10px;">
                > SYSTEM READY<br>> BORDER LOCK: ACTIVE
            </div>
        </div>

        <div id="arsenal-panel" class="panel">
            <h2 style="margin:0; color: #00ff00; font-size: 18px; text-align: center;">ARSENAL</h2>
            <div class="ammo-display" id="ammoCount">0</div>
            <p style="font-size: 9px; text-align: center; color: #00ff00; margin-bottom: 10px;">AVAILABLE PIXEL AMMUNITION</p>
            <button class="btn-buy" onclick="buyAmmo(500, 0.1)">+500 PX (0.1 SOL)</button>
            <button class="btn-buy" onclick="buyAmmo(2000, 0.3)">+2000 PX (0.3 SOL)</button>
        </div>

        <div id="intel-panel">COORD: 0,0 | REGION: ANALYZING...</div>

        <div id="canvas-container">
            <canvas id="war-canvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('war-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('canvas-container');
        const nationSelect = document.getElementById('nationSelect');
        const ammoText = document.getElementById('ammoCount');

        const W = 4000, H = 2000, SLOT = 10;
        canvas.width = W; canvas.height = H;

        let ammo = parseInt(localStorage.getItem('border_ammo_v7') || '500');
        let gridData = JSON.parse(localStorage.getItem('border_data_v7') || '{}');
        const flagCache = {};

        // 1. DİNAMİK DÜNYA ÜLKELERİ LİSTESİ (REST API)
        async function initNations() {
            try {
                const res = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
                const countries = await res.json();
                
                // Alfabetik Sıralama
                countries.sort((a, b) => a.name.common.localeCompare(b.name.common));

                countries.forEach(c => {
                    const code = c.cca2.toLowerCase();
                    let name = c.name.common.toUpperCase();
                    
                    // ÖZEL ŞART: Turkey -> TÜRKİYE
                    if (code === "tr") name = "TÜRKİYE";

                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = name;
                    nationSelect.appendChild(opt);

                    // Bayrak Ön Yükleme
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = `https://flagcdn.com/w320/${code}.png`;
                    img.onload = () => { flagCache[code] = img; };
                });
                
                ammoText.innerText = ammo;
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                alert("Critical: Global Database Connection Failed.");
            }
        }

        // 2. ARSENAL (CEPHANE) YÜKLEME
        async function buyAmmo(amount, price) {
            if (window.solana) {
                try {
                    await window.solana.connect();
                    ammo += amount;
                    localStorage.setItem('border_ammo_v7', ammo);
                    ammoText.innerText = ammo;
                    alert(`Arsenal restocked with ${amount} pixels!`);
                } catch(err) { alert("Transaction failed."); }
            } else { alert("Please install Phantom Wallet."); }
        }

        // 3. HARİTA VE SINIR SİSTEMİ
        const mapImg = new Image();
        mapImg.crossOrigin = "anonymous";
        mapImg.src = 'https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg';

        let scale = 0.5, originX = (window.innerWidth - W * scale) / 2, originY = (window.innerHeight - H * scale) / 2;
        let isDragging = false, dragMoved = false, startX, startY;

        function updateTransform() {
            container.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
        }

        // ZOOM & PAN
        window.addEventListener('wheel', e => {
            e.preventDefault();
            const old = scale;
            scale = Math.min(Math.max(0.1, scale * (e.deltaY < 0 ? 1.1 : 0.9)), 25);
            originX = e.clientX - (e.clientX - originX) * (scale / old);
            originY = e.clientY - (e.clientY - originY) * (scale / old);
            updateTransform();
        }, { passive: false });

        window.addEventListener('mousedown', e => {
            if(e.target.closest('.panel')) return;
            isDragging = true; dragMoved = false;
            startX = e.clientX - originX; startY = e.clientY - originY;
        });

        window.addEventListener('mousemove', e => {
            const x = (e.clientX - originX) / scale;
            const y = (e.clientY - originY) / scale;
            document.getElementById('intel-panel').innerText = `COORD: ${Math.floor(x)},${Math.floor(y)} | STATUS: STANDBY`;
            
            if (isDragging) {
                dragMoved = true;
                originX = e.clientX - startX; originY = e.clientY - startY;
                updateTransform();
            }
        });

        window.addEventListener('mouseup', e => {
            if (isDragging && !dragMoved) handleConquer(e);
            isDragging = false;
        });

        function handleConquer(e) {
            if (ammo <= 0) return alert("OUT OF AMMO! Restock at Arsenal.");

            const x = (e.clientX - originX) / scale;
            const y = (e.clientY - originY) / scale;
            
            // SINIR KONTROLÜ (Piksel Okuma)
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            // Eğer tıkladığın yer siyahsa (deniz) veya çok koyuysa boyama yapmaz
            if (pixel[0] < 50 && pixel[1] < 50 && pixel[2] < 50) return;

            const col = Math.floor(x / SLOT), row = Math.floor(y / SLOT);
            if (gridData[`${col},${row}`]) return; 

            // İşlem Tamam: Kredi düş ve kaydet
            ammo--;
            localStorage.setItem('border_ammo_v7', ammo);
            ammoText.innerText = ammo;

            gridData[`${col},${row}`] = nationSelect.value;
            localStorage.setItem('border_data_v7', JSON.stringify(gridData));
            render();
        }

        function render() {
            ctx.clearRect(0, 0, W, H);
            
            // 1. Ana Haritayı Çiz (Maskeleme için temel)
            ctx.drawImage(mapImg, 0, 0, W, H);

            // 2. Feth Edilen Alanları Çiz
            for (let key in gridData) {
                let [c, r] = key.split(',').map(Number);
                let nation = gridData[key];
                const img = flagCache[nation];
                
                if(img) {
                    ctx.save();
                    // SINIR KİLİDİ: Sadece haritanın kara olan piksellerine çizim yap
                    ctx.globalCompositeOperation = "source-atop";
                    ctx.globalAlpha = 0.9;
                    ctx.drawImage(img, c * SLOT, r * SLOT, SLOT, SLOT);
                    ctx.restore();
                }
            }
        }

        initNations();
        mapImg.onload = () => { render(); updateTransform(); };
        // Netlik ve yüklenen bayraklar için periyodik render
        setInterval(render, 1000);
    </script>
</body>
</html>
