<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Dünya Fetih Simülatörü</title>
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family:Arial, sans-serif;
}
#canvas-container{
  position:absolute;
  top:0;
  left:0;
  transform-origin:0 0;
}
canvas{
  position:absolute;
  top:0;
  left:0;
}
#ui{
  position:fixed;
  top:20px;
  left:20px;
  width:260px;
  background:rgba(20,20,20,0.85);
  backdrop-filter:blur(10px);
  border-radius:12px;
  padding:15px;
  color:#fff;
  box-shadow:0 0 20px rgba(0,0,0,0.6);
}
#ui h2{
  margin-top:0;
  font-size:18px;
}
select{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:none;
  background:#111;
  color:#fff;
}
</style>
</head>
<body>

<div id="ui">
  <h2>Command Center</h2>
  <select id="countrySelect">
    <option value="tr" selected>Türkiye (TR)</option>
    <option value="us">USA (US)</option>
    <option value="ru">Russia (RU)</option>
    <option value="de">Germany (DE)</option>
    <option value="fr">France (FR)</option>
    <option value="cn">China (CN)</option>
    <option value="jp">Japan (JP)</option>
  </select>
</div>

<div id="canvas-container">
  <canvas id="mapCanvas" width="4000" height="2000"></canvas>
  <canvas id="paintCanvas" width="4000" height="2000"></canvas>
</div>

<script>
const MAP_W = 4000;
const MAP_H = 2000;
const SLOT = 15;

const mapCanvas = document.getElementById("mapCanvas");
const paintCanvas = document.getElementById("paintCanvas");
const mapCtx = mapCanvas.getContext("2d");
const paintCtx = paintCanvas.getContext("2d");

paintCtx.imageSmoothingEnabled = false;

const container = document.getElementById("canvas-container");

let scale = 1;
let offsetX = 0;
let offsetY = 0;

let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;

let landMaskData = null;

let paintedSlots = JSON.parse(localStorage.getItem("worldPaintData") || "{}");

const flagCache = {};

function updateTransform(){
  container.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
}

container.addEventListener("mousedown", e=>{
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
});
window.addEventListener("mouseup", ()=> isDragging=false);
window.addEventListener("mousemove", e=>{
  if(!isDragging) return;
  offsetX += (e.clientX - dragStartX);
  offsetY += (e.clientY - dragStartY);
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  updateTransform();
});

window.addEventListener("wheel", e=>{
  e.preventDefault();
  const zoomIntensity = 0.1;
  const wheel = e.deltaY < 0 ? 1 : -1;
  const zoom = Math.exp(wheel * zoomIntensity);

  const rect = container.getBoundingClientRect();
  const cx = (e.clientX - rect.left);
  const cy = (e.clientY - rect.top);

  offsetX -= cx*(zoom-1);
  offsetY -= cy*(zoom-1);
  scale *= zoom;

  updateTransform();
},{passive:false});

function loadMap(){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = ()=>{
    mapCtx.fillStyle="black";
    mapCtx.fillRect(0,0,MAP_W,MAP_H);
    mapCtx.drawImage(img,0,0,MAP_W,MAP_H);
    landMaskData = mapCtx.getImageData(0,0,MAP_W,MAP_H);
    redrawAll();
  };
  img.onerror = ()=>{
    mapCtx.fillStyle="gray";
    mapCtx.fillRect(0,0,MAP_W,MAP_H);
    landMaskData = mapCtx.getImageData(0,0,MAP_W,MAP_H);
  };
  img.src="https://upload.wikimedia.org/wikipedia/commons/b/bb/World_map_blank_gmt.svg";
}

function isLand(x,y){
  const px = Math.floor(x);
  const py = Math.floor(y);
  if(px<0||py<0||px>=MAP_W||py>=MAP_H) return false;
  const i = (py*MAP_W+px)*4;
  const r = landMaskData.data[i];
  const g = landMaskData.data[i+1];
  const b = landMaskData.data[i+2];
  return !(r===0 && g===0 && b===0);
}

paintCanvas.addEventListener("click", e=>{
  const rect = container.getBoundingClientRect();
  const x = (e.clientX - rect.left)/scale;
  const y = (e.clientY - rect.top)/scale;

  if(!isLand(x,y)) return;

  const gx = Math.floor(x/SLOT);
  const gy = Math.floor(y/SLOT);
  const key = gx+","+gy;

  const country = document.getElementById("countrySelect").value;
  paintedSlots[key] = country;
  localStorage.setItem("worldPaintData", JSON.stringify(paintedSlots));
  redrawAll();
});

function loadFlag(code){
  return new Promise(res=>{
    if(flagCache[code]) return res(flagCache[code]);
    const img = new Image();
    img.crossOrigin="anonymous";
    img.onload=()=>{
      flagCache[code]=img;
      res(img);
    };
    img.src=`https://flagcdn.com/w320/${code}.png`;
  });
}

async function redrawAll(){
  paintCtx.clearRect(0,0,MAP_W,MAP_H);

  const visited = new Set();

  for(const key in paintedSlots){
    if(visited.has(key)) continue;
    const [gx,gy] = key.split(",").map(Number);
    const country = paintedSlots[key];

    const queue=[[gx,gy]];
    const group=[];
    visited.add(key);

    while(queue.length){
      const [x,y]=queue.pop();
      group.push([x,y]);
      [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
        const nx=x+d[0], ny=y+d[1];
        const nkey=nx+","+ny;
        if(paintedSlots[nkey]===country && !visited.has(nkey)){
          visited.add(nkey);
          queue.push([nx,ny]);
        }
      });
    }

    const minX=Math.min(...group.map(g=>g[0]));
    const maxX=Math.max(...group.map(g=>g[0]));
    const minY=Math.min(...group.map(g=>g[1]));
    const maxY=Math.max(...group.map(g=>g[1]));

    const width=(maxX-minX+1)*SLOT;
    const height=(maxY-minY+1)*SLOT;

    const flag=await loadFlag(country);

    paintCtx.save();
    paintCtx.globalCompositeOperation="source-over";
    paintCtx.drawImage(flag,minX*SLOT,minY*SLOT,width,height);

    paintCtx.globalCompositeOperation="destination-in";

    paintCtx.beginPath();
    group.forEach(([x,y])=>{
      paintCtx.rect(x*SLOT,y*SLOT,SLOT,SLOT);
    });
    paintCtx.fill();
    paintCtx.restore();

    paintCtx.save();
    paintCtx.globalCompositeOperation="destination-atop";
    paintCtx.drawImage(mapCanvas,0,0);
    paintCtx.restore();
  }
}

loadMap();
updateTransform();
</script>
</body>
</html>
