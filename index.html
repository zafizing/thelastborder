<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>THE LAST BORDER | v4.0 FIXED</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:'Courier New',monospace}
#war-room{width:100vw;height:100vh;position:relative;overflow:hidden}
#canvas-container{position:absolute;transform-origin:0 0}
canvas{position:absolute;top:0;left:0;image-rendering:pixelated}
#ui{
position:fixed;top:20px;left:20px;z-index:9999;
background:rgba(10,10,10,.9);
border:1px solid #ff4500;
padding:15px;width:240px;color:#ff4500
}
select{width:100%;padding:8px;background:#000;color:#ff4500;border:1px solid #ff4500}
button{background:none;border:1px solid #444;color:#444;width:100%;margin-top:10px;font-size:10px;cursor:pointer}
.info{font-size:10px;color:#888;margin-top:8px}
</style>
</head>
<body>

<div id="war-room">
<div id="ui">
<h2 style="margin:0 0 10px 0;font-size:16px">STRATEGIC MAP v4.0</h2>
<select id="nationSelect">
<option value="tr">TÃœRKÄ°YE ðŸ‡¹ðŸ‡·</option>
<option value="az">AZERBAYCAN ðŸ‡¦ðŸ‡¿</option>
</select>
<div class="info">
DRAG: Pan | SCROLL: Zoom<br>
CLICK: Occupy Territory
</div>
<button onclick="localStorage.clear();location.reload()">PURGE DATA</button>
</div>

<div id="canvas-container">
<canvas id="mapCanvas" width="4000" height="2000"></canvas>
<canvas id="paintCanvas" width="4000" height="2000"></canvas>
</div>
</div>

<script>
const W=4000,H=2000,SLOT=20;

const mapCanvas=document.getElementById("mapCanvas");
const paintCanvas=document.getElementById("paintCanvas");
const maskCanvas=document.createElement("canvas");

mapCanvas.width=paintCanvas.width=maskCanvas.width=W;
mapCanvas.height=paintCanvas.height=maskCanvas.height=H;

const mapCtx=mapCanvas.getContext("2d");
const paintCtx=paintCanvas.getContext("2d");
const maskCtx=maskCanvas.getContext("2d");

paintCtx.imageSmoothingEnabled=false;

const container=document.getElementById("canvas-container");
const select=document.getElementById("nationSelect");

let scale=0.4;
let originX=(window.innerWidth-W*scale)/2;
let originY=(window.innerHeight-H*scale)/2;

let isDragging=false,startX=0,startY=0;
let movedDuringDrag=false;

let gridData=JSON.parse(localStorage.getItem("world_v40")||"{}");
let landMaskData=null;

function updateTransform(){
container.style.transform=`translate(${originX}px,${originY}px) scale(${scale})`;
}

window.addEventListener("wheel",e=>{
e.preventDefault();
const zoom=e.deltaY<0?1.1:0.9;
const oldScale=scale;
scale=Math.min(Math.max(0.1,scale*zoom),8);

originX=e.clientX-(e.clientX-originX)*(scale/oldScale);
originY=e.clientY-(e.clientY-originY)*(scale/oldScale);
updateTransform();
},{passive:false});

window.addEventListener("mousedown",e=>{
if(e.target.closest("#ui"))return;
isDragging=true;
startX=e.clientX;
startY=e.clientY;
movedDuringDrag=false;
});

window.addEventListener("mousemove",e=>{
if(!isDragging)return;
if(Math.hypot(e.clientX-startX,e.clientY-startY)>2)movedDuringDrag=true;
originX+=e.clientX-startX;
originY+=e.clientY-startY;
startX=e.clientX;
startY=e.clientY;
updateTransform();
});

window.addEventListener("mouseup",e=>{
if(isDragging && !movedDuringDrag) deploy(e);
isDragging=false;
});

async function loadMap(){
const svgURL="https://upload.wikimedia.org/wikipedia/commons/b/bb/World_map_blank_gmt.svg";
const res=await fetch(svgURL);
const txt=await res.text();
const blob=new Blob([txt],{type:"image/svg+xml"});
const url=URL.createObjectURL(blob);
const img=new Image();
img.onload=()=>{
mapCtx.fillStyle="#000";
mapCtx.fillRect(0,0,W,H);
mapCtx.filter="brightness(0.6) contrast(1.2)";
mapCtx.drawImage(img,0,0,W,H);
mapCtx.filter="none";

maskCtx.drawImage(img,0,0,W,H);
landMaskData=maskCtx.getImageData(0,0,W,H);
render();
};
img.src=url;
}

function isLand(x,y){
if(!landMaskData)return false;
const px=Math.floor(x),py=Math.floor(y);
if(px<0||py<0||px>=W||py>=H)return false;
const i=(py*W+px)*4;
const r=landMaskData.data[i];
const g=landMaskData.data[i+1];
const b=landMaskData.data[i+2];
return (r+g+b)>40;
}

function deploy(e){
const x=(e.clientX-originX)/scale;
const y=(e.clientY-originY)/scale;
if(!isLand(x,y))return;

const col=Math.floor(x/SLOT);
const row=Math.floor(y/SLOT);
gridData[col+","+row]=select.value;
localStorage.setItem("world_v40",JSON.stringify(gridData));
render();
}

function render(){
paintCtx.clearRect(0,0,W,H);
const visited=new Set();

for(const key in gridData){
if(visited.has(key))continue;
const [c,r]=key.split(",").map(Number);
const nation=gridData[key];

const stack=[[c,r]];
const group=[];
visited.add(key);

while(stack.length){
const [x,y]=stack.pop();
group.push([x,y]);
[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
const nk=(x+d[0])+","+(y+d[1]);
if(gridData[nk]===nation&&!visited.has(nk)){
visited.add(nk);
stack.push([x+d[0],y+d[1]]);
}
});
}

paintCtx.save();
paintCtx.beginPath();
group.forEach(([x,y])=>{
paintCtx.rect(x*SLOT,y*SLOT,SLOT,SLOT);
});
paintCtx.clip();

if(nation==="tr"){
paintCtx.fillStyle="#E30A17";
paintCtx.fillRect(0,0,W,H);
}else{
paintCtx.fillStyle="#00b5e2";
paintCtx.fillRect(0,0,W,H);
}

paintCtx.globalCompositeOperation="destination-in";
paintCtx.drawImage(maskCanvas,0,0);
paintCtx.restore();
}
}

loadMap();
updateTransform();
</script>
</body>
</html>
