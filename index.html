<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE LAST BORDER | v14</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        body, html { background: #020205; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        canvas { display: block; background-color: #050505; cursor: crosshair; }
        .ui-panel { position: fixed; z-index: 100; background: rgba(0, 0, 0, 0.9); padding: 15px; border: 1px solid #0f0; border-radius: 4px; }
        #top-left { top: 20px; left: 20px; width: 220px; }
        #top-right { top: 20px; right: 20px; width: 240px; }
        #bottom-right { bottom: 20px; right: 20px; font-size: 11px; }
        #popup { position: fixed; display: none; background: #000; border: 2px solid #ff4500; padding: 15px; z-index: 200; text-align: center; color: #fff; min-width: 160px; }
        button { background: #0f0; color: #000; border: none; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; font-family: inherit; }
        select { background: #000; color: #0f0; border: 1px solid #0f0; width: 100%; padding: 8px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="top-left" class="ui-panel">
        <div style="color: #ff4500; font-weight: bold;">WAR CONSOLE v14</div>
        <select id="nationSelect"></select>
    </div>

    <div id="top-right" class="ui-panel">
        <div id="wallet-status" style="font-size: 10px; color: #ff4500; margin-bottom: 5px; text-align: center;">LOCAL SIMULATION MODE</div>
        <button id="connectBtn" onclick="connectWallet()">CONNECT WALLET</button>
    </div>

    <div id="bottom-right" class="ui-panel">
        <div id="coords">X: 0, Y: 0</div>
        <div id="terrain">TERRAIN: SCANNING...</div>
    </div>

    <div id="popup">
        <div id="pop-coord" style="font-size: 11px; color: #ff4500;">COORD: 0, 0</div>
        <button id="conquerBtn" onclick="localConquer()">CONQUER (FREE)</button>
        <button onclick="closePopup()" style="background:#333; color:#fff;">CANCEL</button>
    </div>

    <canvas id="warMap"></canvas>

    <script>
        const canvas = document.getElementById('warMap');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // 100,000 Piksel Ayarı (400x250 Grid)
        const GRID_W = 400, GRID_H = 250;
        const SLOT_SIZE = 10; 
        const WORLD_W = GRID_W * SLOT_SIZE; // 4000
        const WORLD_H = GRID_H * SLOT_SIZE; // 2500

        let scale = 0.5, offsetX = 50, offsetY = 50;
        let isDragging = false, lastMouseX, lastMouseY;
        let selectedKey = null;
        let localTerritories = {}; // Bayrakları burada tutacağız (Geçici)
        let flagCache = {};

        const mapImg = new Image();
        mapImg.crossOrigin = "anonymous";
        mapImg.src = 'https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg';

        async function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Ülke Listesi
            const res = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
            const countries = await res.json();
            const sel = document.getElementById('nationSelect');
            countries.sort((a,b)=>a.name.common.localeCompare(b.name.common)).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.cca2.toLowerCase();
                opt.textContent = c.name.common.toUpperCase();
                sel.appendChild(opt);
                
                // Bayrakları önbelleğe al
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = `https://flagcdn.com/w80/${opt.value}.png`;
                img.onload = () => { flagCache[opt.value] = img; draw(); };
            });

            mapImg.onload = draw;
            draw();
        }

        function draw() {
            ctx.fillStyle = "#020205";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);

            // Haritayı çiz
            if (mapImg.complete) {
                ctx.drawImage(mapImg, 0, 0, WORLD_W, WORLD_H);
            }

            // Izgara çizimi (Sadece yakınlaşınca gözüksün)
            if (scale > 0.4) {
                ctx.strokeStyle = "rgba(0, 255, 0, 0.05)";
                ctx.beginPath();
                for(let x=0; x<=WORLD_W; x+=SLOT_SIZE*5) { ctx.moveTo(x,0); ctx.lineTo(x,WORLD_H); }
                for(let y=0; y<=WORLD_H; y+=SLOT_SIZE*5) { ctx.moveTo(0,y); ctx.lineTo(WORLD_W,y); }
                ctx.stroke();
            }

            // Boyanan pikselleri (bayrakları) çiz
            for (let key in localTerritories) {
                const [gx, gy] = key.split(',').map(Number);
                const code = localTerritories[key];
                if (flagCache[code]) {
                    ctx.drawImage(flagCache[code], gx * SLOT_SIZE, gy * SLOT_SIZE, SLOT_SIZE, SLOT_SIZE);
                }
            }

            ctx.restore();
        }

        // --- GELİŞMİŞ KAYDIRMA (PAN) ---
        canvas.onmousedown = (e) => {
            if (e.button === 2) { 
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        };

        window.onmouseup = () => isDragging = false;

        canvas.onmousemove = (e) => {
            if (isDragging) {
                offsetX += e.clientX - lastMouseX;
                offsetY += e.clientY - lastMouseY;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                draw();
            }

            const worldX = (e.clientX - offsetX) / scale;
            const worldY = (e.clientY - offsetY) / scale;
            const gx = Math.floor(worldX / SLOT_SIZE);
            const gy = Math.floor(worldY / SLOT_SIZE);

            if(gx >= 0 && gx < GRID_W && gy >= 0 && gy < GRID_H) {
                document.getElementById('coords').innerText = `X: ${gx}, Y: ${gy}`;
                
                // Deniz/Kara Kontrolü (Pixel Sampling)
                const pixel = ctx.getImageData(e.clientX, e.clientY, 1, 1).data;
                const isWater = pixel[2] > 150 && pixel[0] < 100; // Mavi yoğunluk kontrolü
                document.getElementById('terrain').innerText = isWater ? "TERRAIN: WATER (LOCKED)" : "TERRAIN: LAND (READY)";
                document.getElementById('terrain').style.color = isWater ? "#f00" : "#0f0";
            }
        };

        // --- ZOOM ---
        canvas.onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const oldScale = scale;
            scale = Math.min(Math.max(0.05, scale * delta), 15);
            offsetX = e.clientX - (e.clientX - offsetX) * (scale / oldScale);
            offsetY = e.clientY - (e.clientY - offsetY) * (scale / oldScale);
            draw();
        };

        // --- SEÇİM ---
        canvas.onclick = (e) => {
            const worldX = (e.clientX - offsetX) / scale;
            const worldY = (e.clientY - offsetY) / scale;
            const gx = Math.floor(worldX / SLOT_SIZE);
            const gy = Math.floor(worldY / SLOT_SIZE);

            if(gx < 0 || gx >= GRID_W || gy < 0 || gy >= GRID_H) return;

            // Deniz kontrolü tekrarı
            const pixel = ctx.getImageData(e.clientX, e.clientY, 1, 1).data;
            if (pixel[2] > 150 && pixel[0] < 100) return alert("YOU CANNOT CONQUER THE OCEAN!");

            selectedKey = `${gx},${gy}`;
            const pop = document.getElementById('popup');
            pop.style.display = 'block';
            pop.style.left = e.clientX + 'px';
            pop.style.top = e.clientY + 'px';
            document.getElementById('pop-coord').innerText = `COORD: ${gx}, ${gy}`;
        };

        // --- SİMÜLASYON BOYAMA ---
        function localConquer() {
            const code = document.getElementById('nationSelect').value;
            localTerritories[selectedKey] = code;
            draw();
            closePopup();
        }

        function closePopup() { document.getElementById('popup').style.display = 'none'; }
        window.oncontextmenu = (e) => e.preventDefault();
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; draw(); };

        init();
    </script>
</body>
</html>
