<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE LAST BORDER | v8.4.8 FINAL</title>
    <style>
        body, html { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 0; overflow: hidden; }
        #war-room { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        #canvas-container { position: absolute; transform-origin: 0 0; }
        canvas { background-color: #050505; image-rendering: pixelated; cursor: crosshair; }
        .panel { position: fixed; z-index: 100; background: rgba(0, 15, 0, 0.9); padding: 10px; border: 1px solid #0f0; box-shadow: 0 0 10px #0f03; }
        #ui-overlay { top: 15px; left: 15px; width: 220px; }
        #intel-feed { bottom: 15px; right: 15px; width: 200px; font-size: 11px; }
        #buy-popup { position: absolute; z-index: 1000; display: none; background: #000; border: 2px solid #ff4500; padding: 10px; color: #fff; }
        select, button { width: 100%; padding: 5px; margin-top: 5px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: inherit; font-weight: bold; cursor: pointer; }
        button:hover { background: #0f0; color: #000; }
    </style>
</head>
<body>

    <div id="war-room">
        <div id="buy-popup">
            <div id="pop-info" style="font-size: 10px; color: #888;">0, 0</div>
            <div style="color: #ff4500; margin: 5px 0;">TARGET ACQUIRED</div>
            <button onclick="handleConquer()" style="border-color: #ff4500; color: #ff4500;">CONQUER</button>
            <button onclick="closePopup()" style="border-color: #444; color: #444;">CANCEL</button>
        </div>

        <div id="ui-overlay" class="panel">
            <div style="font-size: 12px; border-bottom: 1px solid #0f0; margin-bottom: 5px;">COMMAND CENTER</div>
            <select id="nationSelect"></select>
            <div style="font-size: 10px; margin-top: 10px; color: #ffff00;">SYSTEM: FREE PAINT MODE</div>
        </div>

        <div id="intel-feed" class="panel">
            <div id="coords">COORD: 0, 0</div>
            <div id="status" style="color: #ff4500;">STATUS: READY</div>
        </div>

        <div id="canvas-container"><canvas id="war-canvas"></canvas></div>
    </div>

    <script>
        const canvas = document.getElementById('war-canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const container = document.getElementById('canvas-container');
        const popup = document.getElementById('buy-popup');
        
        // Stabilizasyon için Sabitler
        const W = 4000, H = 2000, SLOT = 10;
        canvas.width = W; canvas.height = H;

        let gridData = JSON.parse(localStorage.getItem('border_v8_final') || '{}');
        const flagCache = {};
        let selectedKey = null;
        let scale = 0.4, originX = (window.innerWidth - W * scale) / 2, originY = (window.innerHeight - H * scale) / 2;
        let isDragging = false, startX, startY, hasMoved = false;

        // Harita Yükleme (Güvenilir Kaynak)
        const mapImg = new Image();
        mapImg.crossOrigin = "anonymous";
        mapImg.src = 'https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg';
        mapImg.onload = () => { render(); };

        function getCanvasPos(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (W / rect.width);
            const y = (e.clientY - rect.top) * (H / rect.height);
            return { x: Math.floor(x), y: Math.floor(y), col: Math.floor(x/SLOT), row: Math.floor(y/SLOT) };
        }

        function handleConquer() {
            if (!selectedKey) return;
            gridData[selectedKey] = document.getElementById('nationSelect').value;
            localStorage.setItem('border_v8_final', JSON.stringify(gridData));
            render();
            closePopup();
        }

        function closePopup() { popup.style.display = 'none'; }

        function render() {
            ctx.imageSmoothingEnabled = false;
            ctx.fillStyle = "#000"; 
            ctx.fillRect(0,0,W,H);

            if (mapImg.complete) {
                ctx.drawImage(mapImg, 0, 0, W, H);
            }

            // Bayraklar
            for (let key in gridData) {
                let [c, r] = key.split(',').map(Number);
                const img = flagCache[gridData[key]];
                if (img && img.complete) {
                    ctx.drawImage(img, c*SLOT, r*SLOT, SLOT, SLOT);
                } else {
                    ctx.fillStyle = "#0f0";
                    ctx.fillRect(c*SLOT, r*SLOT, SLOT, SLOT);
                }
            }

            // Izgara
            ctx.beginPath();
            ctx.strokeStyle = `rgba(0, 255, 0, ${Math.min(0.15, scale/10)})`;
            ctx.lineWidth = 1/scale;
            for(let x=0; x<=W; x+=SLOT) { ctx.moveTo(x,0); ctx.lineTo(x,H); }
            for(let y=0; y<=H; y+=SLOT) { ctx.moveTo(0,y); ctx.lineTo(W,y); }
            ctx.stroke();
        }

        // --- Kontroller ---
        window.onwheel = e => {
            e.preventDefault();
            const old = scale;
            scale = Math.min(Math.max(0.1, scale * (e.deltaY < 0 ? 1.1 : 0.9)), 40);
            originX = e.clientX - (e.clientX - originX) * (scale / old);
            originY = e.clientY - (e.clientY - originY) * (scale / old);
            updateTransform();
        };

        canvas.onmousedown = e => { isDragging = true; startX = e.clientX; startY = e.clientY; hasMoved = false; };
        window.onmousemove = e => {
            if (isDragging) {
                originX += e.clientX - startX;
                originY += e.clientY - startY;
                startX = e.clientX; startY = e.clientY;
                hasMoved = true;
                updateTransform();
            }
            const p = getCanvasPos(e);
            document.getElementById('coords').innerText = `COORD: ${p.col}, ${p.row}`;
        };

        window.onmouseup = e => {
            if (isDragging && !hasMoved) {
                const p = getCanvasPos(e);
                selectedKey = `${p.col},${p.row}`;
                popup.style.display = 'block';
                popup.style.left = e.clientX + 'px';
                popup.style.top = e.clientY + 'px';
                document.getElementById('pop-info').innerText = selectedKey;
            }
            isDragging = false;
        };

        function updateTransform() { 
            container.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`; 
            render();
        }

        async function init() {
            const res = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
            const data = await res.json();
            const sel = document.getElementById('nationSelect');
            data.sort((a,b)=>a.name.common.localeCompare(b.name.common)).forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.cca2.toLowerCase(); 
                opt.textContent = c.name.common.toUpperCase();
                sel.appendChild(opt);
                const img = new Image(); img.crossOrigin = "anonymous";
                img.src = `https://flagcdn.com/w80/${opt.value}.png`;
                img.onload = () => render();
            });
            updateTransform();
        }
        init();
    </script>
</body>
</html>
