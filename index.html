<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>World Conquest Simulator</title>
<style>
html,body{margin:0;overflow:hidden;background:#000;font-family:Arial}
#container{position:absolute;top:0;left:0;transform-origin:0 0}
canvas{position:absolute;top:0;left:0}
#ui{
position:fixed;top:20px;left:20px;
background:rgba(20,20,20,.85);
backdrop-filter:blur(10px);
padding:15px;border-radius:12px;
color:#fff;width:250px
}
select{width:100%;padding:8px;background:#111;color:#fff;border:none;border-radius:6px}
</style>
</head>
<body>

<div id="ui">
<h3>Command Center</h3>
<select id="country">
<option value="tr" selected>TÃ¼rkiye (TR)</option>
<option value="us">USA</option>
<option value="ru">Russia</option>
<option value="de">Germany</option>
<option value="fr">France</option>
<option value="cn">China</option>
<option value="jp">Japan</option>
</select>
</div>

<div id="container">
<canvas id="map" width="4000" height="2000"></canvas>
<canvas id="paint" width="4000" height="2000"></canvas>
</div>

<script>
const W=4000,H=2000,SLOT=15;
const map=document.getElementById("map");
const paint=document.getElementById("paint");
const mctx=map.getContext("2d");
const pctx=paint.getContext("2d");
pctx.imageSmoothingEnabled=false;

const container=document.getElementById("container");

let scale=1,offX=0,offY=0;
let dragging=false,dx=0,dy=0;

let maskData=null;
let painted=JSON.parse(localStorage.getItem("worldPaintData")||"{}");
const flagCache={};

function updateTransform(){
container.style.transform=`translate(${offX}px,${offY}px) scale(${scale})`;
}

container.onmousedown=e=>{dragging=true;dx=e.clientX;dy=e.clientY};
window.onmouseup=()=>dragging=false;
window.onmousemove=e=>{
if(!dragging)return;
offX+=e.clientX-dx;
offY+=e.clientY-dy;
dx=e.clientX;dy=e.clientY;
updateTransform();
};

window.onwheel=e=>{
e.preventDefault();
const zoom=Math.exp((e.deltaY<0?1:-1)*0.1);
const rect=container.getBoundingClientRect();
const cx=e.clientX-rect.left;
const cy=e.clientY-rect.top;
offX-=cx*(zoom-1);
offY-=cy*(zoom-1);
scale*=zoom;
updateTransform();
};

async function loadMap(){
const svgUrl="https://upload.wikimedia.org/wikipedia/commons/b/bb/World_map_blank_gmt.svg";
const res=await fetch(svgUrl);
const text=await res.text();
const blob=new Blob([text],{type:"image/svg+xml"});
const url=URL.createObjectURL(blob);
const img=new Image();
img.onload=()=>{
mctx.fillStyle="black";
mctx.fillRect(0,0,W,H);
mctx.drawImage(img,0,0,W,H);
maskData=mctx.getImageData(0,0,W,H);
redraw();
};
img.src=url;
}

function isLand(x,y){
if(!maskData)return false;
const px=Math.floor(x),py=Math.floor(y);
if(px<0||py<0||px>=W||py>=H)return false;
const i=(py*W+px)*4;
const r=maskData.data[i];
const g=maskData.data[i+1];
const b=maskData.data[i+2];
return (r+g+b)>40;
}

paint.onclick=e=>{
const rect=container.getBoundingClientRect();
const x=(e.clientX-rect.left)/scale;
const y=(e.clientY-rect.top)/scale;
if(!isLand(x,y))return;
const gx=Math.floor(x/SLOT);
const gy=Math.floor(y/SLOT);
painted[gx+","+gy]=country.value;
localStorage.setItem("worldPaintData",JSON.stringify(painted));
redraw();
};

function loadFlag(code){
return new Promise(res=>{
if(flagCache[code])return res(flagCache[code]);
const img=new Image();
img.onload=()=>{flagCache[code]=img;res(img);}
img.src=`https://flagcdn.com/w320/${code}.png`;
});
}

async function redraw(){
pctx.clearRect(0,0,W,H);
const visited=new Set();

for(const key in painted){
if(visited.has(key))continue;
const [gx,gy]=key.split(",").map(Number);
const country=painted[key];

const stack=[[gx,gy]];
const group=[];
visited.add(key);

while(stack.length){
const [x,y]=stack.pop();
group.push([x,y]);
[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
const nk=(x+d[0])+","+(y+d[1]);
if(painted[nk]===country&&!visited.has(nk)){
visited.add(nk);
stack.push([x+d[0],y+d[1]]);
}
});
}

const minX=Math.min(...group.map(g=>g[0]));
const maxX=Math.max(...group.map(g=>g[0]));
const minY=Math.min(...group.map(g=>g[1]));
const maxY=Math.max(...group.map(g=>g[1]));
const w=(maxX-minX+1)*SLOT;
const h=(maxY-minY+1)*SLOT;

const flag=await loadFlag(country);

pctx.save();
pctx.drawImage(flag,minX*SLOT,minY*SLOT,w,h);
pctx.globalCompositeOperation="destination-in";
pctx.beginPath();
group.forEach(([x,y])=>pctx.rect(x*SLOT,y*SLOT,SLOT,SLOT));
pctx.fill();
pctx.restore();

pctx.save();
pctx.globalCompositeOperation="destination-atop";
pctx.drawImage(map,0,0);
pctx.restore();
}
}

loadMap();
updateTransform();
</script>
</body>
</html>
