<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Dünya Fetih Simülatörü</title>
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family:Arial, sans-serif;
}
#canvas-container{
  position:absolute;
  top:0;
  left:0;
  transform-origin:0 0;
}
canvas{
  position:absolute;
  top:0;
  left:0;
}
#ui{
  position:fixed;
  top:20px;
  left:20px;
  width:260px;
  background:rgba(20,20,20,0.85);
  backdrop-filter:blur(10px);
  border-radius:12px;
  padding:15px;
  color:#fff;
  box-shadow:0 0 20px rgba(0,0,0,0.6);
}
#ui h2{ margin:0 0 10px 0; font-size:18px; }
select{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:none;
  background:#111;
  color:#fff;
}
</style>
</head>
<body>

<div id="ui">
  <h2>Command Center</h2>
  <select id="countrySelect">
    <option value="tr" selected>Türkiye (TR)</option>
    <option value="us">USA (US)</option>
    <option value="ru">Russia (RU)</option>
    <option value="de">Germany (DE)</option>
    <option value="fr">France (FR)</option>
    <option value="cn">China (CN)</option>
    <option value="jp">Japan (JP)</option>
  </select>
</div>

<div id="canvas-container">
  <canvas id="mapCanvas" width="4000" height="2000"></canvas>
  <canvas id="paintCanvas" width="4000" height="2000"></canvas>
</div>

<script>
const MAP_W=4000, MAP_H=2000, SLOT=15;

const mapCanvas=document.getElementById("mapCanvas");
const paintCanvas=document.getElementById("paintCanvas");
const mapCtx=mapCanvas.getContext("2d");
const paintCtx=paintCanvas.getContext("2d");
paintCtx.imageSmoothingEnabled=false;

const container=document.getElementById("canvas-container");

let scale=1, offsetX=0, offsetY=0;
let isDragging=false, dragX=0, dragY=0;

let landMaskData=null;
let painted=JSON.parse(localStorage.getItem("worldPaintData")||"{}");
const flagCache={};

function updateTransform(){
  container.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`;
}

container.addEventListener("mousedown",e=>{
  isDragging=true;
  dragX=e.clientX;
  dragY=e.clientY;
});
window.addEventListener("mouseup",()=>isDragging=false);
window.addEventListener("mousemove",e=>{
  if(!isDragging) return;
  offsetX+=e.clientX-dragX;
  offsetY+=e.clientY-dragY;
  dragX=e.clientX;
  dragY=e.clientY;
  updateTransform();
});

window.addEventListener("wheel",e=>{
  e.preventDefault();
  const zoom=Math.exp((e.deltaY<0?1:-1)*0.1);
  const rect=container.getBoundingClientRect();
  const cx=e.clientX-rect.left;
  const cy=e.clientY-rect.top;
  offsetX-=cx*(zoom-1);
  offsetY-=cy*(zoom-1);
  scale*=zoom;
  updateTransform();
},{passive:false});

function loadMap(){
  const img=new Image();
  img.crossOrigin="anonymous";
  img.onload=()=>{
    mapCtx.fillStyle="black";
    mapCtx.fillRect(0,0,MAP_W,MAP_H);
    mapCtx.drawImage(img,0,0,MAP_W,MAP_H);
    landMaskData=mapCtx.getImageData(0,0,MAP_W,MAP_H);
    redraw();
  };
  img.onerror=()=>{
    mapCtx.fillStyle="#777";
    mapCtx.fillRect(0,0,MAP_W,MAP_H);
    landMaskData=mapCtx.getImageData(0,0,MAP_W,MAP_H);
  };

  // PNG raster (CORS safe)
  img.src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution_gray.png";
}

function isLand(x,y){
  const px=Math.floor(x), py=Math.floor(y);
  if(px<0||py<0||px>=MAP_W||py>=MAP_H) return false;
  const i=(py*MAP_W+px)*4;
  const r=landMaskData.data[i];
  const g=landMaskData.data[i+1];
  const b=landMaskData.data[i+2];
  return (r+g+b)>30; // siyah tolerans
}

paintCanvas.addEventListener("click",e=>{
  if(!landMaskData) return;
  const rect=container.getBoundingClientRect();
  const x=(e.clientX-rect.left)/scale;
  const y=(e.clientY-rect.top)/scale;
  if(!isLand(x,y)) return;

  const gx=Math.floor(x/SLOT);
  const gy=Math.floor(y/SLOT);
  painted[gx+","+gy]=countrySelect.value;
  localStorage.setItem("worldPaintData",JSON.stringify(painted));
  redraw();
});

function loadFlag(code){
  return new Promise(res=>{
    if(flagCache[code]) return res(flagCache[code]);
    const img=new Image();
    img.crossOrigin="anonymous";
    img.onload=()=>{flagCache[code]=img;res(img);}
    img.src=`https://flagcdn.com/w320/${code}.png`;
  });
}

async function redraw(){
  paintCtx.clearRect(0,0,MAP_W,MAP_H);
  const visited=new Set();

  for(const key in painted){
    if(visited.has(key)) continue;
    const [gx,gy]=key.split(",").map(Number);
    const country=painted[key];

    const stack=[[gx,gy]];
    const group=[];
    visited.add(key);

    while(stack.length){
      const [x,y]=stack.pop();
      group.push([x,y]);
      [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
        const nk=(x+d[0])+","+(y+d[1]);
        if(painted[nk]===country&&!visited.has(nk)){
          visited.add(nk);
          stack.push([x+d[0],y+d[1]]);
        }
      });
    }

    const minX=Math.min(...group.map(g=>g[0]));
    const maxX=Math.max(...group.map(g=>g[0]));
    const minY=Math.min(...group.map(g=>g[1]));
    const maxY=Math.max(...group.map(g=>g[1]));

    const w=(maxX-minX+1)*SLOT;
    const h=(maxY-minY+1)*SLOT;

    const flag=await loadFlag(country);

    paintCtx.save();
    paintCtx.drawImage(flag,minX*SLOT,minY*SLOT,w,h);
    paintCtx.globalCompositeOperation="destination-in";
    paintCtx.beginPath();
    group.forEach(([x,y])=>{
      paintCtx.rect(x*SLOT,y*SLOT,SLOT,SLOT);
    });
    paintCtx.fill();
    paintCtx.restore();

    paintCtx.save();
    paintCtx.globalCompositeOperation="destination-atop";
    paintCtx.drawImage(mapCanvas,0,0);
    paintCtx.restore();
  }
}

loadMap();
updateTransform();
</script>
</body>
</html>
