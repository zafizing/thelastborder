<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>THE LAST BORDER | v4.0 Redraw</title>
    <style>
        body, html { 
            background-color: #000; color: #d4af37;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        }
        
        #war-room { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        
        #canvas-container { 
            position: absolute; transform-origin: 0 0; will-change: transform;
        }

        canvas { 
            /* SENÄ°N Ã‡Ã–ZÃœMÃœN: HaritayÄ± CSS arka planÄ± yaparak CORS'u bypass ediyoruz */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg');
            background-size: cover;
            background-color: #0d0d0d;
            image-rendering: pixelated;
        }

        #ui-overlay {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            background: rgba(15, 15, 15, 0.95); padding: 20px; border: 1px solid #d4af37;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); width: 250px;
        }
        select { background: #000; color: #d4af37; border: 1px solid #d4af37; padding: 10px; width: 100%; font-size: 1rem; cursor: pointer; }
        .controls { font-size: 0.7rem; color: #888; margin-top: 15px; line-height: 1.4; }
    </style>
</head>
<body>

    <div id="war-room">
        <div id="ui-overlay">
            <h2 style="margin:0 0 10px 0; color: #ff4500; font-size: 1.2rem;">COMMAND CENTER</h2>
            <select id="nationSelect">
                <option value="tr">TÃœRKÄ°YE ðŸ‡¹ðŸ‡·</option>
                <option value="az">AZERBAYCAN ðŸ‡¦ðŸ‡¿</option>
                <option value="us">USA ðŸ‡ºðŸ‡¸</option>
                <option value="de">GERMANY ðŸ‡©ðŸ‡ª</option>
            </select>
            <div class="controls">
                â€¢ [v1.0.6 STABLE NAVIGATION]<br>
                â€¢ DRAG: Pan (1:1 Sync)<br>
                â€¢ SCROLL: Zoom to Cursor<br>
                â€¢ CLICK: Conquer & Auto-Merge
            </div>
            <button onclick="localStorage.clear(); location.reload();" style="margin-top:15px; width:100%; background:none; border:1px solid #444; color:#666; cursor:pointer; font-size:10px;">RESET PROGRESS</button>
        </div>
        <div id="canvas-container">
            <canvas id="war-canvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('war-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        const nationSelect = document.getElementById('nationSelect');

        // Sabitler
        const W = 4000;
        const H = 2000;
        const SLOT = 20; // Bayrak birim boyutu
        
        canvas.width = W;
        canvas.height = H;

        let gridData = JSON.parse(localStorage.getItem('border_data_v4') || '{}');

        // v1.0.6 STABLE NAV LOGIC
        let scale = 0.5;
        let originX = (window.innerWidth - W * scale) / 2;
        let originY = (window.innerHeight - H * scale) / 2;
        let isDragging = false;
        let startX, startY;

        function updateTransform() {
            container.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
        }

        // ZOOM (Fare OdaklÄ±)
        window.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY < 0 ? 1.15 : 0.85;
            const oldScale = scale;
            scale = Math.min(Math.max(0.1, scale * delta), 10);
            
            originX = e.clientX - (e.clientX - originX) * (scale / oldScale);
            originY = e.clientY - (e.clientY - originY) * (scale / oldScale);
            updateTransform();
        }, { passive: false });

        // PANNING (SÃ¼rÃ¼kleme)
        window.addEventListener('mousedown', (e) => {
            if(e.target.closest('#ui-overlay')) return;
            isDragging = true;
            startX = e.clientX - originX;
            startY = e.clientY - originY;
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                originX = e.clientX - startX;
                originY = e.clientY - startY;
                updateTransform();
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (isDragging) {
                const moved = Math.hypot(e.clientX - (startX + originX), e.clientY - (startY + originY));
                if (moved < 5) handleConquer(e);
            }
            isDragging = false;
        });

        function handleConquer(e) {
            const x = (e.clientX - originX) / scale;
            const y = (e.clientY - originY) / scale;

            const col = Math.floor(x / SLOT);
            const row = Math.floor(y / SLOT);

            gridData[`${col},${row}`] = nationSelect.value;
            localStorage.setItem('border_data_v4', JSON.stringify(gridData));
            render();
        }

        function render() {
            // Canvas'Ä± temizle (Åžeffaf bÄ±rakÄ±yoruz ki arka plandaki harita gÃ¶rÃ¼nsÃ¼n)
            ctx.clearRect(0, 0, W, H);

            const visited = new Set();
            for (let key in gridData) {
                if (visited.has(key)) continue;

                let [c, r] = key.split(',').map(Number);
                let nation = gridData[key];

                // --- AKILLI BÄ°RLEÅžME ALGORÄ°TMASI ---
                let cw = 1, ch = 1;
                // SaÄŸa doÄŸru geniÅŸle
                while (gridData[`${c + cw},${r}`] === nation) cw++;
                // AÅŸaÄŸÄ± doÄŸru geniÅŸle
                let canGrowDown = true;
                while (canGrowDown) {
                    for (let i = 0; i < cw; i++) {
                        if (gridData[`${c + i},${r + ch}`] !== nation) {
                            canGrowDown = false;
                            break;
                        }
                    }
                    if (canGrowDown) ch++;
                }

                // Ziyaret edildi olarak iÅŸaretle
                for (let i = 0; i < cw; i++) {
                    for (let j = 0; j < ch; j++) {
                        visited.add(`${c + i},${r + j}`);
                    }
                }

                drawMergedFlag(nation, c * SLOT, r * SLOT, cw * SLOT, ch * SLOT);
            }
        }

        function drawMergedFlag(nation, x, y, w, h) {
            const flag = new Image();
            flag.crossOrigin = "anonymous";
            // FlagCDN Ã¼zerinden Ã§ekiyoruz
            flag.src = `https://flagcdn.com/w320/${nation}.png`;
            
            flag.onload = () => {
                ctx.save();
                // Bayraklar hafif ÅŸeffaf olsun ki altÄ±ndaki harita sÄ±nÄ±rlarÄ± seÃ§ilsin
                ctx.globalAlpha = 0.85;
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(flag, x, y, w, h);
                ctx.restore();
            };
        }

        // Ä°lk baÅŸlatma
        updateTransform();
        render();

    </script>
</body>
</html>
