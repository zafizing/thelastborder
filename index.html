<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>THE LAST BORDER | v3.1 STABLE</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        #war-room { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: #050505; }
        #canvas-container { position: absolute; transform-origin: 0 0; }
        canvas { background: #000; display: block; image-rendering: pixelated; }
        #ui {
            position: fixed; top: 20px; left: 20px; z-index: 9999;
            background: rgba(10, 10, 10, 0.9); padding: 15px; border: 1px solid #ff4500;
            width: 240px; color: #ff4500; pointer-events: auto;
        }
        select { background: #000; color: #ff4500; border: 1px solid #ff4500; width: 100%; padding: 8px; margin-bottom: 10px; }
        .info { font-size: 10px; color: #888; }
    </style>
</head>
<body>

<div id="war-room">
    <div id="ui">
        <h2 style="margin:0 0 10px 0; font-size:16px;">STRATEGIC MAP v3.1</h2>
        <select id="nationSelect">
            <option value="tr">TÃœRKÄ°YE ðŸ‡¹ðŸ‡·</option>
            <option value="az">AZERBAYCAN ðŸ‡¦ðŸ‡¿</option>
        </select>
        <div class="info">
            [v1.0.6 STABLE NAVIGATION]<br>
            DRAG: Pan | SCROLL: Zoom<br>
            CLICK: Occupy Territory
        </div>
        <button onclick="localStorage.clear(); location.reload();" style="background:none; border:1px solid #444; color:#444; width:100%; margin-top:10px; cursor:pointer; font-size:10px;">PURGE DATA</button>
    </div>
    <div id="canvas-container">
        <canvas id="war-canvas"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('war-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    const select = document.getElementById('nationSelect');

    const W = 4000, H = 2000, SLOT = 20;
    canvas.width = W; canvas.height = H;

    let gridData = JSON.parse(localStorage.getItem('world_v31') || '{}');

    // v1.0.6 KAMERA AYARLARI
    let scale = 0.4, originX = (window.innerWidth - W * scale) / 2, originY = (window.innerHeight - H * scale) / 2;
    let isDragging = false, startX, startY;

    // HARÄ°TA YÃœKLEME (FAIL-SAFE: YÃ¼klenmezse siyah ekran vermez)
    const mapImg = new Image();
    mapImg.crossOrigin = "anonymous";
    // Proxy kullanarak Wikipedia engeline takÄ±lmÄ±yoruz
    mapImg.src = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://upload.wikimedia.org/wikipedia/commons/b/bb/World_map_blank_gmt.svg");

    function updateTransform() {
        container.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
    }

    // --- NAVÄ°GASYON DÃ–NGÃœSÃœ ---
    window.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 1.1 : 0.9;
        const oldScale = scale;
        scale = Math.min(Math.max(0.1, scale * delta), 10);
        originX = e.clientX - (e.clientX - originX) * (scale / oldScale);
        originY = e.clientY - (e.clientY - originY) * (scale / oldScale);
        updateTransform();
    }, { passive: false });

    window.addEventListener('mousedown', e => {
        if(e.target.closest('#ui')) return;
        isDragging = true; startX = e.clientX - originX; startY = e.clientY - originY;
    });

    window.addEventListener('mousemove', e => {
        if (isDragging) {
            originX = e.clientX - startX; originY = e.clientY - startY;
            updateTransform();
        }
    });

    window.addEventListener('mouseup', e => {
        if (isDragging) {
            const moved = Math.hypot(e.clientX - (startX + originX), e.clientY - (startY + originY));
            if (moved < 5) deploy(e);
        }
        isDragging = false;
    });

    function deploy(e) {
        const x = (e.clientX - originX) / scale;
        const y = (e.clientY - originY) / scale;

        // Deniz KontrolÃ¼ (Canvas'taki piksel rengine bakÄ±yoruz)
        const p = ctx.getImageData(x, y, 1, 1).data;
        // EÄŸer tÄ±kladÄ±ÄŸÄ±n yer tamamen siyahsa (deniz), boyama yapma
        if (p[0] < 20 && p[1] < 20 && p[2] < 20) return;

        const col = Math.floor(x / SLOT), row = Math.floor(y / SLOT);
        gridData[`${col},${row}`] = select.value;
        localStorage.setItem('world_v31', JSON.stringify(gridData));
        render();
    }

    function render() {
        // 1. Temizlik
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, W, H);

        // 2. Harita Ã‡izimi (EÄŸer yÃ¼klendiyse)
        if (mapImg.complete && mapImg.naturalWidth !== 0) {
            ctx.save();
            ctx.filter = "brightness(0.6) contrast(1.2)";
            ctx.drawImage(mapImg, 0, 0, W, H);
            ctx.restore();
        } else {
            // Harita henÃ¼z gelmediyse veya bozuksa, tÄ±klandÄ±ÄŸÄ±nda boyama yapÄ±labilmesi iÃ§in 
            // tÄ±kla-boya alanÄ±nÄ± belirleyen geÃ§ici bir gri kutu Ã§iz (Siyah ekranÄ± Ã¶nler)
            ctx.fillStyle = "#111";
            ctx.fillRect(100, 100, W-200, H-200);
        }

        // 3. BayraklarÄ± Ã‡iz (Procedural - Resim bekleyip kilitlenmez)
        for (let key in gridData) {
            let [c, r] = key.split(',').map(Number);
            let nation = gridData[key];
            
            ctx.save();
            ctx.translate(c * SLOT, r * SLOT);
            if (nation === 'tr') {
                ctx.fillStyle = '#E30A17';
                ctx.fillRect(0, 0, SLOT, SLOT);
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.arc(SLOT*0.4, SLOT*0.5, SLOT*0.2, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle = '#00b5e2'; ctx.fillRect(0, 0, SLOT, SLOT);
            }
            ctx.restore();
        }
        // Not: BirleÅŸme (merge) algoritmasÄ±nÄ± render hÄ±zÄ±nÄ± dÃ¼ÅŸÃ¼rmemek iÃ§in ÅŸimdilik temel tuttuk.
    }

    // Render DÃ¶ngÃ¼sÃ¼
    setInterval(render, 100); // 10 FPS stabil Ã§izim
    updateTransform();
</script>
</body>
</html>
